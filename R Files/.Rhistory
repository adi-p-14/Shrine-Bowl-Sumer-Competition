duration = sum(dt, na.rm = TRUE),
total_disp = sum(xy_disp, na.rm = TRUE),
.groups = "drop"
)
good_routes <- route_summary %>%
filter(
frames >= 12,
valid_speed_frames >= 2,
duration >= .5,
total_disp >= 6
)
route_df <- route_df %>% semi_join(good_routes, by = "route_id")
View(route_df)
single_route <- route_df %>% filter(route_id == 56)
ggplot(single_route, aes(x = y_s, y = x_s)) +
geom_path(linewidth = 1, color = "blue") +
geom_point(size = 2, color = "red") +
coord_fixed() +
theme_minimal() +
labs(title = "Single Route: route_id = 2132")
single_route <- route_df %>% filter(route_id == 1)
ggplot(single_route, aes(x = y_s, y = x_s)) +
geom_path(linewidth = 1, color = "blue") +
geom_point(size = 2, color = "red") +
coord_fixed() +
theme_minimal() +
labs(title = "Single Route: route_id = 2132")
unique(route_df$route_id)
route_ids <- unique(route_df$route_id)
single_route <- route_df %>% filter(route_id == 4724)
ggplot(single_route, aes(x = y_s, y = x_s)) +
geom_path(linewidth = 1, color = "blue") +
geom_point(size = 2, color = "red") +
coord_fixed() +
theme_minimal() +
labs(title = "Single Route: route_id = 2132")
single_route <- route_df %>% filter(route_id == 4441)
ggplot(single_route, aes(x = y_s, y = x_s)) +
geom_path(linewidth = 1, color = "blue") +
geom_point(size = 2, color = "red") +
coord_fixed() +
theme_minimal() +
labs(title = "Single Route: route_id = 2132")
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/EWS_2024_Game.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("O", 1:10)
compute_player_route_metrics <- function(ds_path, col_gsis_id, drive_levels, min_frames = 12, min_duration = 1, max_extraneous = 20) {
player_df <- ds %>%
filter(gsis_id == col_gsis_id,
drill_type %in% drive_levels) %>%
select(gsis_id, drill_type, ts, x, y, z, a, s) %>%
collect() %>%
arrange(drill_type, ts)
player_df <- player_df %>%
mutate(ts = as.POSIXct(ts, format = "%Y-%m-%dT%H:%M:%OS", tz = "UTC")) %>%
arrange(drill_type, ts)
# 2. Smooth coordinates
player_df <- player_df %>%
group_by(drill_type) %>%
mutate(
x_s = slide_dbl(x, median, .before = 1, .after = 1, .complete = TRUE),
y_s = slide_dbl(y, median, .before = 1, .after = 1, .complete = TRUE)
) %>%
ungroup()
# 3. Displacement + kinematics
route_df <- player_df %>%
group_by(drill_type) %>%
mutate(
dx = x_s - lag(x_s),
dy = y_s - lag(y_s),
dt = as.numeric(difftime(ts, lag(ts), units = "secs")),
xy_disp = sqrt(dx^2 + dy^2),
speed = xy_disp / dt,
heading = atan2(dy, dx),
delta_heading = abs(heading - lag(heading)),
forward_dir = sign(median(dy, na.rm = TRUE)),
forward_progress = dy * forward_dir
) %>%
ungroup()
# 4. Valid motion
route_df <- route_df %>%
mutate(
heading_ok = if_else(speed > 0.9, delta_heading < 0.6, delta_heading < 1.2),
valid_motion = !is.na(speed) & speed < 9 & xy_disp > 0.1 & xy_disp < 1.2 &
heading_ok & (speed > 0.9 | forward_progress > 0.2)
)
# 5. Route termination
route_df <- route_df %>%
group_by(drill_type) %>%
mutate(
stop_low_speed = (speed < 0.5) & coalesce(lag(speed < 0.5), FALSE) & coalesce(lag(speed < 0.7, 2), FALSE),
stop_backward = sign(dy) != forward_dir & abs(dy) > 0.3,
stop_gap = dt > 0.25,
stop_drill = drill_type != lag(drill_type),
stop_route = stop_low_speed | stop_backward | stop_gap | stop_drill
) %>%
ungroup()
# 6. Route segmentation
route_df <- route_df %>%
arrange(drill_type, ts) %>%
mutate(
route_start = replace_na(valid_motion, FALSE) &
(replace_na(stop_route, TRUE) | !replace_na(lag(valid_motion, default = FALSE), FALSE)),
route_id = cumsum(route_start),
route_id = if_else(replace_na(valid_motion, FALSE), route_id, NA_integer_)
)
route_df <- route_df %>%
group_by(route_id) %>%
mutate(
accel = (speed - lag(speed)) / dt
) %>%
ungroup()
# 7. Filter small fragments
route_summary <- route_df %>%
filter(!is.na(route_id)) %>%
group_by(route_id) %>%
summarise(
frames = n(),
valid_speed_frames = sum(!is.na(speed)),
valid_accel_frames = sum(!is.na(accel)),
duration = sum(dt, na.rm = TRUE),
total_disp = sum(xy_disp, na.rm = TRUE),
.groups = "drop"
)
good_routes <- route_summary %>%
filter(
frames >= 12,
valid_speed_frames >= 2,
duration >= .5,
total_disp >= 6
)
route_df <- route_df %>% semi_join(good_routes, by = "route_id")
# 8. Compute route-level metrics
print("About to summarise route metrics")
route_metrics <- route_df %>%
group_by(gsis_id, drill_type, route_id) %>%
summarise(
frames = n(),
duration = sum(dt, na.rm = TRUE),
avg_speed = mean(speed, na.rm = TRUE),
p75_speed = if (any(!is.na(speed))) {
quantile(speed, 0.75, na.rm = TRUE)
} else {
NA_real_
},
max_speed = if (any(!is.na(speed))) {
max(speed, na.rm = TRUE)
} else {
NA_real_
},
p95_accel = if_else(any(!is.na(accel)), quantile(accel, 0.95, na.rm = TRUE), NA_real_),
max_accel = if (any(!is.na(accel))) {
max(accel, na.rm = TRUE)
} else {
NA_real_
},
total_disp = sum(xy_disp, na.rm = TRUE),
net_disp = sqrt((last(x_s) - first(x_s))^2 + (last(y_s) - first(y_s))^2),
extraneous_dist = total_disp - net_disp,
waste_ratio = extraneous_dist / net_disp,
.groups = "drop"
)
print("Summarise complete")
return(route_metrics)
}
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- all_metrics_ol
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_West_Practice_1.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
View(slice)
drills <- "Team"
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- "Team"
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
View(all_metrics_ol)
View(all_data_ol)
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_West_Practice_2.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
View(slice)
drills <- paste0("Team ", 1:2)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_West_Practice_3.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
View(slice)
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("Team ", 1:2)
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_East_Practice_3.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("Team ", 1:3)
compute_player_route_metrics <- function(ds_path, col_gsis_id, drive_levels, min_frames = 12, min_duration = 1, max_extraneous = 20) {
player_df <- ds %>%
filter(gsis_id == col_gsis_id,
drill_type %in% drive_levels) %>%
select(gsis_id, drill_type, ts, x, y, z, a, s) %>%
collect() %>%
arrange(drill_type, ts)
player_df <- player_df %>%
mutate(ts = as.POSIXct(ts, format = "%Y-%m-%dT%H:%M:%OS", tz = "UTC")) %>%
arrange(drill_type, ts)
# 2. Smooth coordinates
player_df <- player_df %>%
group_by(drill_type) %>%
mutate(
x_s = slide_dbl(x, median, .before = 1, .after = 1, .complete = TRUE),
y_s = slide_dbl(y, median, .before = 1, .after = 1, .complete = TRUE)
) %>%
ungroup()
# 3. Displacement + kinematics
route_df <- player_df %>%
group_by(drill_type) %>%
mutate(
dx = x_s - lag(x_s),
dy = y_s - lag(y_s),
dt = as.numeric(difftime(ts, lag(ts), units = "secs")),
xy_disp = sqrt(dx^2 + dy^2),
speed = xy_disp / dt,
heading = atan2(dy, dx),
delta_heading = abs(heading - lag(heading)),
forward_dir = sign(median(dy, na.rm = TRUE)),
forward_progress = dy * forward_dir
) %>%
ungroup()
# 4. Valid motion
route_df <- route_df %>%
mutate(
heading_ok = if_else(speed > 0.9, delta_heading < 0.6, delta_heading < 1.2),
valid_motion = !is.na(speed) & speed < 9 & xy_disp > 0.1 & xy_disp < 1.2 &
heading_ok & (speed > 0.9 | forward_progress > 0.2)
)
# 5. Route termination
route_df <- route_df %>%
group_by(drill_type) %>%
mutate(
stop_low_speed = (speed < 0.5) & coalesce(lag(speed < 0.5), FALSE) & coalesce(lag(speed < 0.7, 2), FALSE),
stop_backward = sign(dy) != forward_dir & abs(dy) > 0.3,
stop_gap = dt > 0.25,
stop_drill = drill_type != lag(drill_type),
stop_route = stop_low_speed | stop_backward | stop_gap | stop_drill
) %>%
ungroup()
# 6. Route segmentation
route_df <- route_df %>%
arrange(drill_type, ts) %>%
mutate(
route_start = replace_na(valid_motion, FALSE) &
(replace_na(stop_route, TRUE) | !replace_na(lag(valid_motion, default = FALSE), FALSE)),
route_id = cumsum(route_start),
route_id = if_else(replace_na(valid_motion, FALSE), route_id, NA_integer_)
)
route_df <- route_df %>%
group_by(route_id) %>%
mutate(
accel = (speed - lag(speed)) / dt
) %>%
ungroup()
# 7. Filter small fragments
route_summary <- route_df %>%
filter(!is.na(route_id)) %>%
group_by(route_id) %>%
summarise(
frames = n(),
valid_speed_frames = sum(!is.na(speed)),
valid_accel_frames = sum(!is.na(accel)),
duration = sum(dt, na.rm = TRUE),
total_disp = sum(xy_disp, na.rm = TRUE),
.groups = "drop"
)
good_routes <- route_summary %>%
filter(
frames >= 12,
valid_speed_frames >= 2,
duration >= .5,
total_disp >= 6
)
route_df <- route_df %>% semi_join(good_routes, by = "route_id")
# 8. Compute route-level metrics
print("About to summarise route metrics")
route_metrics <- route_df %>%
group_by(gsis_id, drill_type, route_id) %>%
summarise(
frames = n(),
duration = sum(dt, na.rm = TRUE),
avg_speed = mean(speed, na.rm = TRUE),
p75_speed = if (any(!is.na(speed))) {
quantile(speed, 0.75, na.rm = TRUE)
} else {
NA_real_
},
max_speed = if (any(!is.na(speed))) {
max(speed, na.rm = TRUE)
} else {
NA_real_
},
p95_accel = if_else(any(!is.na(accel)), quantile(accel, 0.95, na.rm = TRUE), NA_real_),
max_accel = if (any(!is.na(accel))) {
max(accel, na.rm = TRUE)
} else {
NA_real_
},
total_disp = sum(xy_disp, na.rm = TRUE),
net_disp = sqrt((last(x_s) - first(x_s))^2 + (last(y_s) - first(y_s))^2),
extraneous_dist = total_disp - net_disp,
waste_ratio = extraneous_dist / net_disp,
.groups = "drop"
)
print("Summarise complete")
return(route_metrics)
}
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_East_Practice_2.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("Team ", 1:3)
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/2024_East_Practice_1.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("Team ", 1:3)
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- bind_rows(all_data_ol, all_metrics_ol)
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
ds <- open_dataset("C:/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/EWS_2025_Game.snappy.parquet")
available_ids <- ds %>%
select(gsis_id) %>%
distinct() %>%
collect()
slice <- ds %>%
distinct(drill_type) %>%
collect()
ol_df <- read_excel(player_file, sheet = "OL") %>%
select(college_gsis_id, player_name)
valid_ol <- ol_df %>%
mutate(college_gsis_id = as.character(college_gsis_id)) %>%
semi_join(
available_ids,
by = c("college_gsis_id" = "gsis_id")
)
drills <- paste0("Drive ", 1:13)
all_metrics_ol <- lapply(1:nrow(valid_ol), function(i) {
res <- compute_player_route_metrics(ds, valid_ol$college_gsis_id[i], drills) %>%
mutate(player_name = valid_ol$player_name[i])%>%
group_by(route_id)
# Print progress
print(paste0(valid_ol$college_gsis_id[i], ": Done"))
gc()  # free memory before next iteration
return(res)
}) %>% bind_rows()
all_data_ol <- all_metrics_ol
write.csv(all_data_ol, "/Users/jayap/OneDrive/Documents/Shrine Bowl Analytics Competition/ol_practice_data.csv", row.names = FALSE)
